(version 1)

; inspired by Chrome's sandbox policy and OpenAI Codex:
; https://source.chromium.org/chromium/chromium/src/+/main:sandbox/policy/mac/common.sb;l=273-319;drc=7b3962fe2e5fc9e2ee58000dc8fbf3429d84d3bd
; https://source.chromium.org/chromium/chromium/src/+/main:sandbox/policy/mac/renderer.sb;l=64;drc=7b3962fe2e5fc9e2ee58000dc8fbf3429d84d3bd
; https://github.com/openai/codex/blob/main/codex-rs/core/src/seatbelt_base_policy.sbpl

; start with closed-by-default
(deny default)

; child processes inherit the policy of their parent
(allow process-exec)
(allow process-fork)
(allow signal (target same-sandbox))

; Allow cf prefs to work.
(allow user-preference-read)

; process-info
(allow process-info* (target same-sandbox))

(allow file-write-data
  (require-all
    (path "/dev/null")
    (vnode-type CHARACTER-DEVICE)
  )
)

; sysctls permitted.
(allow sysctl-read
  (sysctl-name "hw.activecpu")
  (sysctl-name "hw.busfrequency_compat")
  (sysctl-name "hw.byteorder")
  (sysctl-name "hw.cacheconfig")
  (sysctl-name "hw.cachelinesize_compat")
  (sysctl-name "hw.cpufamily")
  (sysctl-name "hw.cpufrequency_compat")
  (sysctl-name "hw.cputype")
  (sysctl-name "hw.l1dcachesize_compat")
  (sysctl-name "hw.l1icachesize_compat")
  (sysctl-name "hw.l2cachesize_compat")
  (sysctl-name "hw.l3cachesize_compat")
  (sysctl-name "hw.logicalcpu_max")
  (sysctl-name "hw.machine")
  (sysctl-name "hw.memsize")
  (sysctl-name "hw.ncpu")
  (sysctl-name "hw.nperflevels")
  ; Chrome locks these CPU feature detection down a bit more tightly,
  ; but mostly for fingerprinting concerns which isn't an issue for codex.
  (sysctl-name-prefix "hw.optional.arm.")
  (sysctl-name-prefix "hw.optional.armv8_")
  (sysctl-name "hw.packages")
  (sysctl-name "hw.pagesize_compat")
  (sysctl-name "hw.pagesize")
  (sysctl-name "hw.physicalcpu_max")
  (sysctl-name "hw.tbfrequency_compat")
  (sysctl-name "hw.vectorunit")
  (sysctl-name "kern.hostname")
  (sysctl-name "kern.maxfilesperproc")
  (sysctl-name "kern.maxproc")
  (sysctl-name "kern.osproductversion")
  (sysctl-name "kern.osrelease")
  (sysctl-name "kern.ostype")
  (sysctl-name "kern.osvariant_status")
  (sysctl-name "kern.osversion")
  (sysctl-name "kern.secure_kernel")
  (sysctl-name "kern.usrstack64")
  (sysctl-name "kern.version")
  (sysctl-name "sysctl.proc_cputype")
  (sysctl-name "vm.loadavg")
  (sysctl-name-prefix "hw.perflevel")
  (sysctl-name-prefix "kern.proc.pgrp.")
  (sysctl-name-prefix "kern.proc.pid.")
  (sysctl-name-prefix "net.routetable.")
)

; Allow Java to set CPU type grade when required
(allow sysctl-write
(sysctl-name "kern.grade_cputype"))

; IOKit
(allow iokit-open
  (iokit-registry-entry-class "RootDomainUserClient")
)

; needed to look up user info, see https://crbug.com/792228
(allow mach-lookup
  (global-name "com.apple.system.opendirectoryd.libinfo")
)


; Added on top of Chrome profile
; Needed for python multiprocessing on MacOS for the SemLock
(allow ipc-posix-sem)

(allow mach-lookup
  (global-name "com.apple.PowerManagement.control")
)

; ADDITIONAL RULES

; additional sysctls
(allow sysctl-read
  (sysctl-name "security.mac.lockdown_mode_state")
  (sysctl-name "kern.bootargs")
  (sysctl-name "machdep.ptrauth_enabled")
)

; allow read across entire filesystem except the user's home directory
; two explicit rules: allow all, then deny home override
(allow file-read* (subpath "/"))
(deny file-read* (subpath (param "USER_HOME_DIR")))

; common services touched by CLIs
(allow mach-lookup
  (global-name "com.apple.logd")
  (global-name "com.apple.system.notification_center")
  (global-name "com.apple.diagnosticd")
)

; allow read and write to dtrace helper (some runtimes probe this)
(allow file-read-data (literal "/dev/dtracehelper"))
(allow file-write-data (literal "/dev/dtracehelper"))

; TTY/PTY
(allow file-read* (literal "/dev/tty") (regex #"/dev/tty.*") (literal "/dev/ptmx"))
(allow file-write* (literal "/dev/tty") (regex #"/dev/tty.*"))
(allow file-ioctl (literal "/dev/tty") (regex #"/dev/tty.*") (literal "/dev/ptmx"))

; Devices
(allow file-read* (literal "/dev/urandom") (literal "/dev/random") (literal "/dev/null"))
(allow file-write-data (literal "/dev/null"))

; Allow workdir and /tmp, /var RO
(allow file-read*
  (literal "/")  ; required to do ~anything related to reading directories
  (subpath (param "WRITABLE_ROOT_0"))
  (subpath (param "WRITABLE_ROOT_1"))
  (subpath (param "WRITABLE_ROOT_2"))
  (subpath (param "WRITABLE_ROOT_3"))
  (subpath (param "WRITABLE_ROOT_4"))
)

; Allow workdir and /tmp, /var write
(allow file-write*
  ; WRITABLE_ROOT_0 is the cwd, excluding its top-level .git if present
  (require-all (subpath (param "WRITABLE_ROOT_0")) (require-not (subpath (param "WRITABLE_ROOT_0_RO_0"))) )
  (subpath (param "WRITABLE_ROOT_1"))
  (subpath (param "WRITABLE_ROOT_2"))
  (subpath (param "WRITABLE_ROOT_3"))
  (subpath (param "WRITABLE_ROOT_4"))
)

; Additional allow file-write's
(allow file-write*
	(subpath (param "RW_ROOT_0"))
	(subpath (param "RW_ROOT_1"))
)
